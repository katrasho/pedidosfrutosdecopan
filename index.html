<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frutos de Copán - Gestión de Inventario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .sidebar-bg { background-color: #2c3e50; }
        .header-bg { background-color: #ffffff; border-bottom: 1px solid #e2e8f0; }
        .text-accent { color: #f59e0b; }
        .bg-accent { background-color: #f59e0b; }
        .hover-bg-accent:hover { background-color: #ea7f00; }
        .tab-active { background-color: #f59e0b; color: white; border-radius: 0.375rem; }
        .tab-inactive { color: #d1d5db; }
        .tab-inactive:hover { background-color: #3b526a; }
        .view-content { display: none; }
        .view-content.active { display: block; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f59e0b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chart-container { position: relative; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; height: 300px; max-height: 400px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem 0;
            margin-bottom: 1rem;
        }
        .logo-container img {
            max-height: 50px;
            width: auto;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="loadingScreen" class="fixed inset-0 bg-gray-100 flex flex-col justify-center items-center z-50 hidden">
        <div class="loader"></div>
        <p id="loadingMessage" class="mt-4 text-gray-700">Conectando con Google Sheets...</p>
    </div>

    <div id="app" class="min-h-screen flex hidden">
        <aside id="sidebar" class="w-64 sidebar-bg p-4 hidden md:flex flex-col shadow-lg">
            <div class="logo-container">
                <img src="https://images.unsplash.com/photo-1579613619586-318353381665" alt="Frutos de Copán Logo">
            </div>
            <nav class="space-y-2">
                <a href="#" id="solicitudesTab" class="flex items-center space-x-2 p-3 rounded-md transition-colors tab-active">
                    <span class="font-medium text-white">Solicitudes</span>
                </a>
                <a href="#" id="dashboardTab" class="flex items-center space-x-2 p-3 rounded-md transition-colors tab-inactive admin-only hidden">
                    <span class="font-medium">Dashboard</span>
                </a>
                <a href="#" id="reportesTab" class="flex items-center space-x-2 p-3 rounded-md transition-colors tab-inactive admin-only hidden">
                    <span class="font-medium">Reportes</span>
                </a>
                <a href="#" id="configTab" class="flex items-center space-x-2 p-3 rounded-md transition-colors tab-inactive admin-only hidden">
                    <span class="font-medium">Configuración</span>
                </a>
            </nav>
            <div class="mt-auto pt-4 border-t border-gray-700 text-sm text-gray-400">
                <p>Versión 1.2</p>
            </div>
        </aside>

        <main id="main-content" class="flex-1 p-4 md:p-8 overflow-y-auto">
            <header class="flex justify-between items-center mb-6 p-4 header-bg rounded-lg shadow-md">
                <div class="md:hidden">
                    <button id="mobileMenuBtn" class="text-gray-600 focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                </div>
                <span id="userNameDisplay" class="ml-auto mr-4 text-sm font-medium text-gray-600 hidden"></span>
                <button id="loginButton" class="bg-blue-600 text-white py-2 px-4 rounded-md text-sm font-medium hover:bg-blue-700 transition-colors">Ingresar</button>
                <button id="signOutButton" class="bg-red-500 text-white py-2 px-4 rounded-md text-sm font-medium hover:bg-red-600 transition-colors hidden">Salir</button>
            </header>

            <section id="solicitudesView" class="view-content active">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Historial de Solicitudes</h2>
                    <button id="addSolicitudBtn" class="bg-accent text-white py-2 px-4 rounded-md text-sm font-medium hover-bg-accent transition-colors">+ Nueva Solicitud</button>
                </div>
                <div id="solicitudesList" class="space-y-4">
                    <p class="text-center text-gray-500">Cargando solicitudes...</p>
                </div>
            </section>

            <section id="dashboardView" class="view-content">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Dashboard de Gestión</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="card border-l-4 border-accent">
                        <h3 class="text-md font-semibold text-gray-500">Total Solicitudes</h3>
                        <p id="totalSolicitudes" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                    </div>
                    <div class="card border-l-4 border-green-500">
                        <h3 class="text-md font-semibold text-gray-500">Productos Activos</h3>
                        <p id="totalProductosActivos" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                    </div>
                    <div class="card border-l-4 border-blue-500">
                        <h3 class="text-md font-semibold text-gray-500">Solicitudes en Proceso</h3>
                        <p id="solicitudesEnProceso" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Productos más solicitados</h3>
                        <div class="chart-container"><canvas id="topProductsChart"></canvas></div>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Solicitudes por Ubicación</h3>
                        <div class="chart-container"><canvas id="locationChart"></canvas></div>
                    </div>
                </div>
            </section>

            <section id="reportesView" class="view-content">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Reporte de Solicitudes</h2>
                <div class="overflow-x-auto card">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ubicación</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comentarios</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Productos</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="7" class="text-center p-8 text-gray-500">Cargando datos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="configView" class="view-content">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Configuración del Sistema</h2>
                <div class="card space-y-4">
                    <div>
                        <label for="scriptUrlInput" class="block text-sm font-medium text-gray-700">URL del Google Apps Script</label>
                        <input type="text" id="scriptUrlInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="Pega la URL aquí">
                    </div>
                    <div class="flex space-x-4">
                        <button id="saveConfigButton" class="bg-accent text-white py-2 px-4 rounded-md font-medium hover-bg-accent transition-colors">Guardar URL</button>
                        <button id="testConnectionButton" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-md font-medium hover:bg-gray-300 transition-colors">Probar Conexión</button>
                    </div>
                    <p id="connectionStatus" class="text-sm font-medium"></p>
                </div>
            </section>
        </main>
    </div>

    <div id="solicitudModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative bg-white rounded-lg shadow-xl p-8 max-w-2xl w-full mx-4">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" id="closeModalBtn">&times;</button>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Nueva Solicitud</h3>
            <form id="solicitudForm" class="space-y-4">
                <input type="hidden" id="solicitudUser" name="solicitudUser">
                <input type="hidden" id="solicitudEmail" name="solicitudEmail">

                <div>
                    <label for="solicitudDate" class="block text-sm font-medium text-gray-700">Fecha</label>
                    <input type="date" id="solicitudDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required>
                </div>
                <div>
                    <label for="solicitudType" class="block text-sm font-medium text-gray-700">Tipo de Solicitud</label>
                    <select id="solicitudType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                        <option value="Degustación">Degustación</option>
                        <option value="Promoción">Promoción</option>
                        <option value="Evento">Evento</option>
                    </select>
                </div>
                <div>
                    <label for="solicitudLocation" class="block text-sm font-medium text-gray-700">Ubicación</label>
                    <select id="solicitudLocation" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required>
                        <option value="">Selecciona una ubicación</option>
                        <option value="San Pedro Sula">San Pedro Sula</option>
                        <option value="Tegucigalpa">Tegucigalpa</option>
                        <option value="La Ceiba">La Ceiba</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Productos</label>
                    <div id="productosContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                    </div>
                </div>
                <div>
                    <label for="solicitudComments" class="block text-sm font-medium text-gray-700">Comentarios (Requerido)</label>
                    <textarea id="solicitudComments" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required></textarea>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancelFormBtn" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-md font-medium hover:bg-gray-300 transition-colors">Cancelar</button>
                    <button type="submit" id="submitFormBtn" class="bg-accent text-white py-2 px-4 rounded-md font-medium hover-bg-accent transition-colors">Enviar Solicitud</button>
                </div>
            </form>
        </div>
    </div>

    <div id="loginModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" id="closeLoginModalBtn">&times;</button>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Iniciar Sesión</h3>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="emailInput" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                    <input type="email" id="emailInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required>
                </div>
                <div>
                    <label for="passwordInput" class="block text-sm font-medium text-gray-700">Contraseña</label>
                    <input type="password" id="passwordInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required>
                </div>
                <button type="submit" id="loginBtnModal" class="w-full bg-accent text-white py-2 px-4 rounded-md font-medium hover-bg-accent transition-colors">
                    Ingresar
                </button>
            </form>
            <p id="loginMessage" class="mt-4 text-center text-red-500 text-sm"></p>
        </div>
    </div>

    <div id="notificationContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw3MrfinkqGnwjzEli0oIjYg64J2NI0XWjZFbabEVtiZYrej4p7dIFhA4WHgbopWTQgyA/exec';

        let allSolicitudes = [];
        let allProductos = [];
        let currentUser = { email: null, name: null, nivel: null, isAuthenticated: false };
        let charts = {};

        const elements = {
            loadingScreen: document.getElementById('loadingScreen'),
            app: document.getElementById('app'),
            loginButton: document.getElementById('loginButton'),
            signOutButton: document.getElementById('signOutButton'),
            loginModal: document.getElementById('loginModal'),
            closeLoginModalBtn: document.getElementById('closeLoginModalBtn'),
            loginForm: document.getElementById('loginForm'),
            emailInput: document.getElementById('emailInput'),
            passwordInput: document.getElementById('passwordInput'),
            loginBtnModal: document.getElementById('loginBtnModal'),
            loginMessage: document.getElementById('loginMessage'),
            userNameDisplay: document.getElementById('userNameDisplay'),
            solicitudesTab: document.getElementById('solicitudesTab'),
            dashboardTab: document.getElementById('dashboardTab'),
            reportesTab: document.getElementById('reportesTab'),
            configTab: document.getElementById('configTab'),
            solicitudesView: document.getElementById('solicitudesView'),
            dashboardView: document.getElementById('dashboardView'),
            reportesView: document.getElementById('reportesView'),
            configView: document.getElementById('configView'),
            solicitudesList: document.getElementById('solicitudesList'),
            addSolicitudBtn: document.getElementById('addSolicitudBtn'),
            solicitudModal: document.getElementById('solicitudModal'),
            closeModalBtn: document.getElementById('closeModalBtn'),
            solicitudForm: document.getElementById('solicitudForm'),
            cancelFormBtn: document.getElementById('cancelFormBtn'),
            productosContainer: document.getElementById('productosContainer'),
            notificationContainer: document.getElementById('notificationContainer'),
            totalSolicitudes: document.getElementById('totalSolicitudes'),
            totalProductosActivos: document.getElementById('totalProductosActivos'),
            solicitudUser: document.getElementById('solicitudUser'),
            solicitudEmail: document.getElementById('solicitudEmail'),
            solicitudDate: document.getElementById('solicitudDate'),
            solicitudType: document.getElementById('solicitudType'),
            solicitudLocation: document.getElementById('solicitudLocation'),
            solicitudComments: document.getElementById('solicitudComments'),
            reportTableBody: document.getElementById('reportTableBody'),
            mobileMenuBtn: document.getElementById('mobileMenuBtn'),
            sidebar: document.getElementById('sidebar'),
        };

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `p-4 rounded-md shadow-lg text-white font-medium mb-2 transition-transform transform translate-x-full duration-500 ease-out ${type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-blue-500')}`;
            notification.textContent = message;
            elements.notificationContainer.appendChild(notification);
            setTimeout(() => notification.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                notification.addEventListener('transitionend', () => notification.remove());
            }, 5000);
        }

        function switchView(viewId) {
            document.querySelectorAll('.view-content').forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');

            document.querySelectorAll('a[id$="Tab"]').forEach(tab => {
                tab.classList.replace('tab-active', 'tab-inactive');
                tab.classList.remove('text-white');
            });

            const targetTab = document.getElementById(`${viewId.replace('View', 'Tab')}`);
            if (targetTab) {
                targetTab.classList.replace('tab-inactive', 'tab-active');
                targetTab.classList.add('text-white');
            }
            if (elements.sidebar.classList.contains('mobile-active')) {
                elements.sidebar.classList.remove('mobile-active');
                elements.sidebar.classList.add('hidden');
                elements.main_content.classList.remove('md:ml-64');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = elements.emailInput.value;
            const password = elements.passwordInput.value;
            elements.loginBtnModal.disabled = true;
            elements.loginBtnModal.textContent = 'Verificando...';

            try {
                const url = new URL(GOOGLE_APPS_SCRIPT_URL);
                url.searchParams.append('action', 'login');
                url.searchParams.append('email', email);
                url.searchParams.append('password', password);

                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    currentUser = {
                        email: result.data.correo,
                        name: result.data.nombre,
                        nivel: result.data.nivel,
                        isAuthenticated: true
                    };
                    elements.loginModal.classList.add('hidden');
                    elements.userNameDisplay.textContent = `(${currentUser.name} - Nivel ${currentUser.nivel})`;
                    elements.userNameDisplay.classList.remove('hidden');
                    setupAppForUserRole();
                    await loadData();
                    showNotification('Inicio de sesión exitoso.', 'success');
                } else {
                    elements.loginMessage.textContent = result.error || 'Credenciales incorrectas.';
                }
            } catch (error) {
                console.error('Login error:', error);
                elements.loginMessage.textContent = 'Error de conexión. Inténtalo de nuevo.';
            } finally {
                elements.loginBtnModal.disabled = false;
                elements.loginBtnModal.textContent = 'Ingresar';
            }
        }

        function setupAppForUserRole() {
            elements.loginButton.classList.add('hidden');
            elements.signOutButton.classList.remove('hidden');
            if (currentUser.nivel == 1) {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
                switchView('solicitudesView');
            } else {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
                switchView('solicitudesView');
            }
        }

        async function loadData() {
            elements.loadingScreen.classList.remove('hidden');
            elements.app.classList.add('hidden');

            try {
                const productosResponse = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getProductos`);
                const productosData = await productosResponse.json();
                if (productosData.success) {
                    allProductos = productosData.data;
                    renderProductosForForm();
                } else {
                    throw new Error(productosData.error);
                }

                let solicitudesUrl;
                if (currentUser.isAuthenticated) {
                    solicitudesUrl = `${GOOGLE_APPS_SCRIPT_URL}?action=getSolicitudes&userEmail=${currentUser.email}&limit=5`;
                } else {
                    solicitudesUrl = `${GOOGLE_APPS_SCRIPT_URL}?action=getSolicitudes&userEmail=guest`;
                }
                const solicitudesResponse = await fetch(solicitudesUrl);
                const solicitudesData = await solicitudesResponse.json();

                if (solicitudesData.success) {
                    allSolicitudes = solicitudesData.data;
                    renderSolicitudes();
                    if (currentUser.nivel == 1) {
                        const allSolicitudesResponse = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getSolicitudes&userEmail=admin`);
                        const allSolicitudesData = await allSolicitudesResponse.json();
                        if (allSolicitudesData.success) {
                            allSolicitudes = allSolicitudesData.data;
                            renderReportTable();
                            updateDashboard();
                        }
                    }
                } else {
                    throw new Error(solicitudesData.error);
                }
            } catch (error) {
                console.error('Error al cargar datos:', error);
                showNotification('Error al cargar datos: ' + error.message, 'error');
            } finally {
                elements.loadingScreen.classList.add('hidden');
                elements.app.classList.remove('hidden');
            }
        }

        function renderSolicitudes() {
            const list = elements.solicitudesList;
            list.innerHTML = '';

            if (allSolicitudes.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500">No hay solicitudes para mostrar.</p>';
                return;
            }
            allSolicitudes.forEach(solicitud => {
                const item = document.createElement('div');
                item.className = 'card';

                let productosText = 'No especificado';
                try {
                    const productos = JSON.parse(solicitud.Productos || '{}');
                    productosText = Object.entries(productos)
                        .map(([nombre, cantidad]) => `${nombre}: ${cantidad}`)
                        .join(', ');
                } catch (e) {
                    console.error("Error parsing Productos JSON:", e);
                }

                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h4 class="text-lg font-medium text-gray-800">Solicitud ID: ${solicitud.ID}</h4>
                        <span class="text-sm text-gray-500">${solicitud.Fecha}</span>
                    </div>
                    <p class="text-gray-600 mt-1">Usuario: ${solicitud.Usuario} (${solicitud.Email})</p>
                    <p class="text-gray-600 mt-1">Ubicación: ${solicitud.Ubicación}</p>
                    <p class="text-gray-600 mt-1">Productos: ${productosText || 'No especificado'}</p>
                    <p class="text-sm text-gray-500 mt-2">Comentarios: ${solicitud.Comentarios || 'N/A'}</p>
                `;
                list.appendChild(item);
            });
        }

        function renderProductosForForm() {
            const container = elements.productosContainer;
            container.innerHTML = '';
            allProductos.filter(p => p.Activo).forEach(producto => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between space-x-4 p-2 border border-gray-300 rounded-md bg-white';
                div.innerHTML = `
                    <label for="producto-${producto.Nombre}" class="text-sm text-gray-700">${producto.Nombre}</label>
                    <input type="number" id="producto-${producto.Nombre}" name="productos" data-product-name="${producto.Nombre}" value="0" min="0" class="w-20 p-1 border border-gray-300 rounded-md text-center focus:border-accent focus:ring-accent">
                `;
                container.appendChild(div);
            });
        }

        function updateDashboard() {
            if (currentUser.nivel != 1) return;

            elements.totalSolicitudes.textContent = allSolicitudes.length;
            const activos = allProductos.filter(p => p.Activo).length;
            elements.totalProductosActivos.textContent = activos;

            const solicitudesEnProceso = allSolicitudes.filter(s => s.Estado === 'En Proceso').length;
            elements.solicitudesEnProceso.textContent = solicitudesEnProceso;


            if (allSolicitudes.length > 0) {
                renderTopProductsChart();
                renderLocationChart();
            } else {
                document.getElementById('topProductsChart').parentNode.innerHTML = '<p class="text-center text-gray-500 p-8">No hay datos de productos para mostrar.</p>';
                document.getElementById('locationChart').parentNode.innerHTML = '<p class="text-center text-gray-500 p-8">No hay datos de ubicación para mostrar.</p>';
            }
        }

        function renderTopProductsChart() {
            const chartCanvas = document.getElementById('topProductsChart');
            if (!chartCanvas) return;

            const ctx = chartCanvas.getContext('2d');

            const productCounts = {};
            allSolicitudes.forEach(s => {
                try {
                    const productos = JSON.parse(s.Productos || '{}');
                    for (const [producto, cantidad] of Object.entries(productos)) {
                        productCounts[producto] = (productCounts[producto] || 0) + parseInt(cantidad);
                    }
                } catch(e) {}
            });

            const sortedProducts = Object.entries(productCounts)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 10);

            const labels = sortedProducts.map(p => p[0]);
            const data = sortedProducts.map(p => p[1]);

            if (charts.topProducts) charts.topProducts.destroy();
            charts.topProducts = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cantidad Solicitada',
                        data: data,
                        backgroundColor: 'rgba(245, 158, 11, 0.7)',
                        borderColor: 'rgba(245, 158, 11, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function renderLocationChart() {
            const chartCanvas = document.getElementById('locationChart');
            if (!chartCanvas) return;

            const ctx = chartCanvas.getContext('2d');

            const locationCounts = {};
            allSolicitudes.forEach(s => {
                const location = s.Ubicación || 'Sin Ubicación';
                locationCounts[location] = (locationCounts[location] || 0) + 1;
            });

            const labels = Object.keys(locationCounts);
            const data = Object.values(locationCounts);

            if (charts.location) charts.location.destroy();
            charts.location = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Solicitudes',
                        data: data,
                        backgroundColor: [
                            '#f59e0b',
                            '#10b981',
                            '#3b82f6',
                            '#ef4444',
                            '#6366f1',
                            '#a855f7'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }

        function renderReportTable() {
            const tbody = elements.reportTableBody;
            tbody.innerHTML = '';
            if (allSolicitudes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center p-8 text-gray-500">No hay datos de solicitudes para el reporte.</td></tr>';
                return;
            }
            allSolicitudes.forEach(solicitud => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                let productosText = 'N/A';
                try {
                    const productos = JSON.parse(solicitud.Productos);
                    productosText = Object.entries(productos)
                        .map(([nombre, cantidad]) => `${nombre}: ${cantidad}`)
                        .join(', ');
                } catch (e) {
                    console.error("Error parsing Productos JSON for report:", e);
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${solicitud.ID}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${solicitud.Fecha}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${solicitud.Usuario}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${solicitud.Ubicación}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${solicitud.Tipo}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${solicitud.Comentarios}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${productosText}</td>
                `;
                tbody.appendChild(row);
            });
        }

        elements.loginButton.addEventListener('click', () => elements.loginModal.classList.remove('hidden'));
        elements.closeLoginModalBtn.addEventListener('click', () => elements.loginModal.classList.add('hidden'));
        elements.loginForm.addEventListener('submit', handleLogin);

        elements.signOutButton.addEventListener('click', () => {
            currentUser = { email: null, name: null, nivel: null, isAuthenticated: false };
            elements.userNameDisplay.textContent = '';
            elements.userNameDisplay.classList.add('hidden');
            elements.loginButton.classList.remove('hidden');
            elements.signOutButton.classList.add('hidden');
            document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
            switchView('solicitudesView');
            loadData();
            showNotification('Sesión cerrada.', 'info');
        });

        elements.solicitudesTab.addEventListener('click', (e) => { e.preventDefault(); switchView('solicitudesView'); renderSolicitudes(); });
        if (elements.dashboardTab) { elements.dashboardTab.addEventListener('click', (e) => { e.preventDefault(); switchView('dashboardView'); updateDashboard(); }); }
        if (elements.reportesTab) { elements.reportesTab.addEventListener('click', (e) => { e.preventDefault(); switchView('reportesView'); renderReportTable(); }); }
        if (elements.configTab) { elements.configTab.addEventListener('click', (e) => { e.preventDefault(); switchView('configView'); }); }

        elements.addSolicitudBtn.addEventListener('click', () => {
            if (!currentUser.isAuthenticated) {
                showNotification('Debes iniciar sesión para hacer una solicitud.', 'error');
                return;
            }
            elements.solicitudUser.value = currentUser.name;
            elements.solicitudEmail.value = currentUser.email;
            elements.solicitudDate.valueAsDate = new Date();
            document.querySelectorAll('#productosContainer input[type="number"]').forEach(input => {
                input.value = "0";
            });
            elements.solicitudComments.value = '';
            elements.solicitudLocation.value = '';

            elements.solicitudModal.classList.remove('hidden');
        });
        elements.closeModalBtn.addEventListener('click', () => elements.solicitudModal.classList.add('hidden'));
        elements.cancelFormBtn.addEventListener('click', () => elements.solicitudModal.classList.add('hidden'));

        elements.solicitudForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const selectedProducts = {};
            document.querySelectorAll('#productosContainer input[type="number"]').forEach(input => {
                const quantity = parseInt(input.value);
                if (quantity > 0) {
                    const productName = input.getAttribute('data-product-name');
                    selectedProducts[productName] = quantity;
                }
            });

            if (Object.keys(selectedProducts).length === 0) {
                showNotification('Debes seleccionar al menos un producto para la solicitud.', 'error');
                return;
            }

            if (!elements.solicitudComments.value.trim()) {
                showNotification('El campo de comentarios es requerido.', 'error');
                return;
            }

            const solicitudData = {
                date: elements.solicitudDate.value,
                type: elements.solicitudType.value,
                location: elements.solicitudLocation.value,
                products: selectedProducts,
                comments: elements.solicitudComments.value,
                user: elements.solicitudUser.value,
                email: elements.solicitudEmail.value,
                userId: currentUser.email
            };

            const submitButton = document.getElementById('submitFormBtn');
            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';

            const result = await postToGoogleSheets('addSolicitud', solicitudData);

            if (result.success) {
                showNotification('Solicitud agregada correctamente.', 'success');
                elements.solicitudModal.classList.add('hidden');
                elements.solicitudForm.reset();
                loadData();
            } else {
                showNotification('Error al enviar la solicitud: ' + (result.error || 'Inténtalo de nuevo.'), 'error');
            }
            submitButton.disabled = false;
            submitButton.textContent = 'Enviar Solicitud';
        });

        async function postToGoogleSheets(action, data) {
            try {
                const formData = new FormData();
                formData.append('action', action);
                formData.append('data', JSON.stringify(data));

                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: formData,
                    redirect: 'follow',
                });
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error en postToGoogleSheets:', error);
                return { success: false, error: 'Error de red. Inténtalo de nuevo.' };
            }
        }

        elements.mobileMenuBtn.addEventListener('click', () => {
            elements.sidebar.classList.toggle('hidden');
            elements.sidebar.classList.toggle('mobile-active');
        });

        window.addEventListener('load', loadData);
    </script>
</body>
</html>
