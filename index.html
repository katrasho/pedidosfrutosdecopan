<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Inventario de Bodega - Google Sheets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .chart-container { position: relative; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; height: 300px; max-height: 400px; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        .tab-active { background-color: #3b82f6; color: #ffffff; }
        .tab-inactive { color: #6b7280; }
        .tab-inactive:hover { background-color: #f3f4f6; }
        .view-content { display: none; }
        .view-content.active { display: block; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .table-responsive {
            overflow-x: auto;
        }
        .sidebar-mobile-visible {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 40;
            transform: translateX(0);
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-mobile-hidden {
            transform: translateX(-100%);
        }
        .backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 30;
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="loadingScreen" class="fixed inset-0 bg-gray-100 flex flex-col justify-center items-center z-50 hidden">
        <div class="loader"></div>
        <p id="loadingMessage" class="mt-4 text-gray-700">Conectando con Google Sheets...</p>
    </div>
    
    <div id="app" class="min-h-screen flex flex-col md:flex-row hidden">
        <div id="backdrop" class="backdrop"></div>
        <aside id="sidebar" class="w-64 bg-white p-4 flex-col shadow-lg fixed inset-y-0 left-0 z-40 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-xl font-bold text-gray-800">Gestión de Inventario</h1>
                <button id="closeSidebarBtn" class="md:hidden text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <nav class="space-y-2">
                <a href="#" id="solicitudesTab" class="flex items-center space-x-2 p-3 rounded-md font-medium transition-colors tab-active">
                    <i class="fas fa-clipboard-list w-5"></i>
                    <span>Solicitudes</span>
                </a>
                <a href="#" id="dashboardTab" class="flex items-center space-x-2 p-3 rounded-md font-medium transition-colors tab-inactive admin-only hidden">
                    <i class="fas fa-chart-bar w-5"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" id="reportesTab" class="flex items-center space-x-2 p-3 rounded-md font-medium transition-colors tab-inactive admin-only hidden">
                    <i class="fas fa-file-invoice w-5"></i>
                    <span>Reportes</span>
                </a>
                <a href="#" id="configTab" class="flex items-center space-x-2 p-3 rounded-md font-medium transition-colors tab-inactive admin-only hidden">
                    <i class="fas fa-cog w-5"></i>
                    <span>Configuración</span>
                </a>
            </nav>
            <div class="mt-auto pt-4 border-t border-gray-200 text-sm text-gray-500">
                <p>Versión 1.0</p>
            </div>
        </aside>

        <main id="main-content" class="flex-1 p-4 md:p-8 overflow-y-auto">
            <header class="flex justify-between items-center mb-6">
                <button id="menuBtn" class="md:hidden text-gray-600 hover:text-gray-800 focus:outline-none">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <div class="flex items-center ml-auto">
                    <span id="userNameDisplay" class="mr-4 text-sm font-medium text-gray-600 hidden"></span>
                    <button id="loginButton" class="bg-blue-600 text-white py-2 px-4 rounded-md text-sm font-medium hover:bg-blue-700 transition-colors">Ingresar</button>
                    <button id="signOutButton" class="bg-red-500 text-white py-2 px-4 rounded-md text-sm font-medium hover:bg-red-600 transition-colors hidden">Salir</button>
                </div>
            </header>

            <section id="solicitudesView" class="view-content active">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Historial de Solicitudes</h2>
                    <button id="addSolicitudBtn" class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-2 px-4 rounded-md text-sm font-medium hover:from-blue-600 hover:to-indigo-700 transition-colors shadow-md flex items-center space-x-2">
                        <i class="fas fa-plus-circle"></i>
                        <span>Nueva Solicitud</span>
                    </button>
                </div>
                <div id="solicitudesList" class="space-y-4">
                    <p class="text-center text-gray-500">Cargando solicitudes...</p>
                </div>
            </section>

            <section id="dashboardView" class="view-content">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Dashboard de Gestión</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-blue-500 flex items-center space-x-4">
                        <div class="p-3 bg-blue-100 rounded-full text-blue-600">
                            <i class="fas fa-list-alt fa-lg"></i>
                        </div>
                        <div>
                            <h3 class="text-md font-semibold text-gray-500">Total Solicitudes</h3>
                            <p id="totalSolicitudes" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-green-500 flex items-center space-x-4">
                        <div class="p-3 bg-green-100 rounded-full text-green-600">
                            <i class="fas fa-boxes fa-lg"></i>
                        </div>
                        <div>
                            <h3 class="text-md font-semibold text-gray-500">Productos Activos</h3>
                            <p id="totalProductosActivos" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-yellow-500 flex items-center space-x-4">
                        <div class="p-3 bg-yellow-100 rounded-full text-yellow-600">
                            <i class="fas fa-hourglass-half fa-lg"></i>
                        </div>
                        <div>
                            <h3 class="text-md font-semibold text-gray-500">Solicitudes en Proceso</h3>
                            <p id="solicitudesEnProceso" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Productos más solicitados</h3>
                        <div class="chart-container"><canvas id="topProductsChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Solicitudes por Ubicación</h3>
                        <div class="chart-container"><canvas id="locationChart"></canvas></div>
                    </div>
                </div>
            </section>

            <section id="reportesView" class="view-content">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Reporte de Solicitudes</h2>
                <div class="flex items-center mb-4 space-x-4 admin-only hidden">
                    <label for="reportFilter" class="text-sm font-medium text-gray-700">Mostrar:</label>
                    <select id="reportFilter" class="p-2 border rounded-md">
                        <option value="all">Todas</option>
                        <option value="active">Solo Activas</option>
                    </select>
                </div>
                <div class="overflow-x-auto bg-white rounded-lg shadow-md table-responsive">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuario</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ubicación</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comentarios</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Productos</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Activa</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="9" class="text-center p-8 text-gray-500">Cargando datos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="configView" class="view-content">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Configuración del Sistema</h2>
                <div class="bg-white p-6 rounded-lg shadow-md space-y-4">
                    <div>
                        <label for="scriptUrlInput" class="block text-sm font-medium text-gray-700">URL del Google Apps Script</label>
                        <input type="text" id="scriptUrlInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" placeholder="Pega la URL aquí">
                    </div>
                    <div class="flex space-x-4">
                        <button id="saveConfigButton" class="bg-blue-600 text-white py-2 px-4 rounded-md font-medium hover:bg-blue-700 transition-colors">Guardar URL</button>
                        <button id="testConnectionButton" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-md font-medium hover:bg-gray-300 transition-colors">Probar Conexión</button>
                    </div>
                    <p id="connectionStatus" class="text-sm font-medium"></p>
                </div>
            </section>
        </main>
    </div>

    <div id="solicitudModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative bg-white rounded-lg shadow-xl p-8 max-w-4xl w-full mx-4 my-8">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" id="closeModalBtn">&times;</button>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Crear Nueva Solicitud</h3>
            <p class="text-sm text-gray-600 mb-6">Complete el siguiente formulario para solicitar productos de la bodega. Asegúrese de especificar el tipo de solicitud, la ubicación y las cantidades de cada producto.</p>
            <form id="solicitudForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="solicitudDate" class="block text-sm font-medium text-gray-700">Fecha</label>
                        <input type="date" id="solicitudDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required>
                    </div>
                    <div>
                        <label for="solicitudType" class="block text-sm font-medium text-gray-700">Tipo de Solicitud</label>
                        <select id="solicitudType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                            <option value="Cambios">Cambios</option>
                            <option value="Degustaciones">Degustaciones</option>
                            <option value="Muestras">Muestras</option>
                            <option value="Pedido">Pedido</option>
                        </select>
                    </div>
                    <div>
                        <label for="solicitudLocation" class="block text-sm font-medium text-gray-700">Ubicación</label>
                        <select id="solicitudLocation" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required>
                            <option value="San Pedro Sula">San Pedro Sula</option>
                            <option value="Puerto Cortes">Puerto Cortes</option>
                            <option value="La Ceiba">La Ceiba</option>
                            <option value="Tegucigalpa">Tegucigalpa</option>
                            <option value="Copan">Copan</option>
                        </select>
                    </div>
                </div>

                <div>
                    <h4 class="block text-sm font-medium text-gray-700 mb-2">Productos</h4>
                    <div id="productosContainer" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    </div>
                </div>
                
                <div>
                    <label for="solicitudComments" class="block text-sm font-medium text-gray-700">Nombre del Destino (Supermercado, Negocio o Cliente)</label>
                    <textarea id="solicitudComments" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required></textarea>
                </div>
                <div class="hidden">
                    <label for="solicitudUser" class="block text-sm font-medium text-gray-700">Nombre de Usuario</label>
                    <input type="text" id="solicitudUser" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div class="hidden">
                    <label for="solicitudEmail" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                    <input type="email" id="solicitudEmail" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" id="cancelFormBtn" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-md font-medium hover:bg-gray-300 transition-colors">Cancelar</button>
                    <button type="submit" id="submitFormBtn" class="bg-blue-600 text-white py-2 px-4 rounded-md font-medium hover:bg-blue-700 transition-colors">Enviar Solicitud</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="loginModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="relative bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
            <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" id="closeLoginModalBtn">&times;</button>
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Iniciar Sesión</h3>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="emailInput" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                    <input type="email" id="emailInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required>
                </div>
                <div>
                    <label for="passwordInput" class="block text-sm font-medium text-gray-700">Contraseña</label>
                    <input type="password" id="passwordInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2" required>
                </div>
                <button type="submit" id="loginBtnModal" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md font-medium hover:bg-blue-700 transition-colors">
                    Ingresar
                </button>
            </form>
            <p id="loginMessage" class="mt-4 text-center text-red-500 text-sm"></p>
        </div>
    </div>
    
    <div id="notificationContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw6SLFNCElTUdrhIkCaQAH7k6_3mdyCGyPGtRqQzowVteORhZoGgKXUzy5W1FxSBQw/exec';

        let allSolicitudes = [];
        let allProductos = [];
        let currentUser = { email: null, name: null, nivel: null, isAuthenticated: false };
        let charts = {};

        const elements = {
            loadingScreen: document.getElementById('loadingScreen'),
            app: document.getElementById('app'),
            loginButton: document.getElementById('loginButton'),
            signOutButton: document.getElementById('signOutButton'),
            loginModal: document.getElementById('loginModal'),
            closeLoginModalBtn: document.getElementById('closeLoginModalBtn'),
            loginForm: document.getElementById('loginForm'),
            emailInput: document.getElementById('emailInput'),
            passwordInput: document.getElementById('passwordInput'),
            loginBtnModal: document.getElementById('loginBtnModal'),
            loginMessage: document.getElementById('loginMessage'),
            userNameDisplay: document.getElementById('userNameDisplay'),
            solicitudesTab: document.getElementById('solicitudesTab'),
            dashboardTab: document.getElementById('dashboardTab'),
            reportesTab: document.getElementById('reportesTab'),
            configTab: document.getElementById('configTab'),
            solicitudesView: document.getElementById('solicitudesView'),
            dashboardView: document.getElementById('dashboardView'),
            reportesView: document.getElementById('reportesView'),
            configView: document.getElementById('configView'),
            solicitudesList: document.getElementById('solicitudesList'),
            addSolicitudBtn: document.getElementById('addSolicitudBtn'),
            solicitudModal: document.getElementById('solicitudModal'),
            closeModalBtn: document.getElementById('closeModalBtn'),
            solicitudForm: document.getElementById('solicitudForm'),
            cancelFormBtn: document.getElementById('cancelFormBtn'),
            productosContainer: document.getElementById('productosContainer'),
            notificationContainer: document.getElementById('notificationContainer'),
            totalSolicitudes: document.getElementById('totalSolicitudes'),
            totalProductosActivos: document.getElementById('totalProductosActivos'),
            solicitudesEnProceso: document.getElementById('solicitudesEnProceso'),
            solicitudUser: document.getElementById('solicitudUser'),
            solicitudEmail: document.getElementById('solicitudEmail'),
            solicitudDate: document.getElementById('solicitudDate'),
            solicitudType: document.getElementById('solicitudType'),
            solicitudLocation: document.getElementById('solicitudLocation'),
            solicitudComments: document.getElementById('solicitudComments'),
            reportTableBody: document.getElementById('reportTableBody'),
            reportFilter: document.getElementById('reportFilter'),
            sidebar: document.getElementById('sidebar'),
            menuBtn: document.getElementById('menuBtn'),
            closeSidebarBtn: document.getElementById('closeSidebarBtn'),
            backdrop: document.getElementById('backdrop')
        };

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `p-4 rounded-md shadow-lg text-white font-medium mb-2 transition-transform transform translate-x-full duration-500 ease-out ${type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-blue-500')}`;
            notification.textContent = message;
            elements.notificationContainer.appendChild(notification);
            setTimeout(() => notification.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                notification.addEventListener('transitionend', () => notification.remove());
            }, 5000);
        }

        function switchView(viewId) {
            document.querySelectorAll('.view-content').forEach(view => view.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            document.querySelectorAll('a[id$="Tab"]').forEach(tab => tab.classList.replace('tab-active', 'tab-inactive'));
            const targetTab = document.getElementById(`${viewId.replace('View', 'Tab')}`);
            if (targetTab) {
                targetTab.classList.replace('tab-inactive', 'tab-active');
            }
            if (window.innerWidth < 768) {
                toggleSidebar();
            }
        }

        function toggleSidebar() {
            const sidebar = elements.sidebar;
            const backdrop = elements.backdrop;
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('translate-x-0');
                backdrop.style.display = 'block';
            } else {
                sidebar.classList.remove('translate-x-0');
                sidebar.classList.add('-translate-x-full');
                backdrop.style.display = 'none';
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = elements.emailInput.value;
            const password = elements.passwordInput.value;
            elements.loginBtnModal.disabled = true;
            elements.loginBtnModal.textContent = 'Verificando...';

            try {
                const url = new URL(GOOGLE_APPS_SCRIPT_URL);
                url.searchParams.append('action', 'login');
                url.searchParams.append('email', email);
                url.searchParams.append('password', password);

                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    currentUser = {
                        email: result.data.correo,
                        name: result.data.nombre,
                        nivel: result.data.nivel,
                        isAuthenticated: true
                    };
                    elements.loginModal.classList.add('hidden');
                    elements.userNameDisplay.textContent = `${currentUser.name} - Nivel ${currentUser.nivel}`;
                    elements.userNameDisplay.classList.remove('hidden');
                    setupAppForUserRole();
                    await loadData();
                    showNotification('Inicio de sesión exitoso.', 'success');
                } else {
                    elements.loginMessage.textContent = result.error || 'Credenciales inválidas.';
                }
            } catch (error) {
                console.error('Login error:', error);
                elements.loginMessage.textContent = 'Error de conexión. Inténtalo de nuevo.';
            } finally {
                elements.loginBtnModal.disabled = false;
                elements.loginBtnModal.textContent = 'Ingresar';
            }
        }

        function setupAppForUserRole() {
            elements.loginButton.classList.add('hidden');
            elements.signOutButton.classList.remove('hidden');
            if (currentUser.nivel == 1) {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
                switchView('solicitudesView');
            } else {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
                switchView('solicitudesView');
            }
        }

        async function loadData() {
            elements.loadingScreen.classList.remove('hidden');
            elements.app.classList.add('hidden');

            try {
                const productosResponse = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getProductos`);
                const productosData = await productosResponse.json();
                if (productosData.success) {
                    allProductos = productosData.data;
                    renderProductosForForm();
                } else {
                    throw new Error(productosData.error);
                }
                let solicitudesUrl;
                if (currentUser.isAuthenticated && currentUser.nivel == 1) {
                    solicitudesUrl = `${GOOGLE_APPS_SCRIPT_URL}?action=getSolicitudes&userEmail=admin`;
                } else if (currentUser.isAuthenticated) {
                    solicitudesUrl = `${GOOGLE_APPS_SCRIPT_URL}?action=getSolicitudes&userEmail=${currentUser.email}&limit=5`;
                } else {
                    solicitudesUrl = `${GOOGLE_APPS_SCRIPT_URL}?action=getSolicitudes&userEmail=guest`;
                }
                const solicitudesResponse = await fetch(solicitudesUrl);
                const solicitudesData = await solicitudesResponse.json();
                if (solicitudesData.success) {
                    allSolicitudes = solicitudesData.data;
                    renderSolicitudes();
                    if (currentUser.nivel == 1) {
                        updateDashboard();
                        renderReportTable();
                    }
                } else {
                    throw new Error(solicitudesData.error);
                }
            } catch (error) {
                console.error('Error al cargar datos:', error);
                showNotification('Error al cargar datos: ' + error.message, 'error');
            } finally {
                elements.loadingScreen.classList.add('hidden');
                elements.app.classList.remove('hidden');
            }
        }

        function renderSolicitudes() {
            const list = elements.solicitudesList;
            list.innerHTML = '';

            let solicitudesToShow = allSolicitudes;
            if (currentUser.nivel !== 1) {
                 solicitudesToShow = allSolicitudes.filter(sol => sol.Activa === true);
            }
            if (solicitudesToShow.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500">No hay solicitudes para mostrar.</p>';
                return;
            }
            solicitudesToShow.forEach(solicitud => {
                const item = document.createElement('div');
                item.className = 'bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition duration-300 ease-in-out';
                let productosText = 'No especificado';
                try {
                    const productos = JSON.parse(solicitud.Productos || '{}');
                    productosText = Object.entries(productos)
                        .map(([nombre, cantidad]) => `${nombre}: ${cantidad}`)
                        .join(', ');
                } catch (e) {
                    console.error("Error parsing Productos JSON:", e);
                }
                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <h4 class="text-lg font-medium text-gray-800">Solicitud ID: ${solicitud.ID}</h4>
                        <span class="text-sm text-gray-500">${solicitud.Fecha}</span>
                    </div>
                    <p class="text-gray-600 mt-1"><strong class="font-medium">Usuario:</strong> ${solicitud.Usuario}</p>
                    <p class="text-gray-600 mt-1"><strong class="font-medium">Correo:</strong> ${solicitud.Email}</p>
                    <p class="text-gray-600 mt-1"><strong class="font-medium">Ubicación:</strong> ${solicitud.Ubicacion}</p>
                    <p class="text-gray-600 mt-1"><strong class="font-medium">Productos:</strong> ${productosText || 'No especificado'}</p>
                    <p class="text-sm text-gray-500 mt-2"><strong class="font-medium">Destino:</strong> ${solicitud.Comentarios || 'N/A'}</p>
                `;
                list.appendChild(item);
            });
        }

        function renderProductosForForm() {
            const container = elements.productosContainer;
            container.innerHTML = '';
            allProductos.filter(p => p.Activo).forEach(producto => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200';
                div.innerHTML = `
                    <h5 class="text-sm font-semibold text-gray-700 mb-2">${producto.Nombre}</h5>
                    <label for="cantidad-${producto.Nombre}" class="sr-only">Cantidad de ${producto.Nombre}</label>
                    <input type="number" id="cantidad-${producto.Nombre}" name="cantidad-${producto.Nombre}" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 text-center" />
                `;
                container.appendChild(div);
            });
        }

        function updateDashboard() {
            if (currentUser.nivel != 1) return;
            if (elements.totalSolicitudes) elements.totalSolicitudes.textContent = allSolicitudes.length;
            const activos = allProductos.filter(p => p.Activo).length;
            if (elements.totalProductosActivos) elements.totalProductosActivos.textContent = activos;
            const solicitudesEnProceso = allSolicitudes.filter(s => s.Activa === true).length;
            if (elements.solicitudesEnProceso) elements.solicitudesEnProceso.textContent = solicitudesEnProceso;
            if (allSolicitudes.length > 0) {
                renderTopProductsChart();
                renderLocationChart();
            } else {
                if(document.getElementById('topProductsChart')) document.getElementById('topProductsChart').parentNode.innerHTML = '<p class="text-center text-gray-500 p-8">No hay datos de productos para mostrar.</p>';
                if(document.getElementById('locationChart')) document.getElementById('locationChart').parentNode.innerHTML = '<p class="text-center text-gray-500 p-8">No hay datos de ubicación para mostrar.</p>';
            }
        }

        function renderTopProductsChart() {
            const chartCanvas = document.getElementById('topProductsChart');
            if (!chartCanvas) return;
            const ctx = chartCanvas.getContext('2d');
            const productCounts = {};
            allSolicitudes.forEach(s => {
                try {
                    const productos = JSON.parse(s.Productos || '{}');
                    for (const [producto, cantidad] of Object.entries(productos)) {
                        productCounts[producto] = (productCounts[producto] || 0) + parseInt(cantidad);
                    }
                } catch(e) {}
            });
            const sortedProducts = Object.entries(productCounts)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 10);
            const labels = sortedProducts.map(p => p[0]);
            const data = sortedProducts.map(p => p[1]);
            if (charts.topProducts) charts.topProducts.destroy();
            charts.topProducts = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cantidad Solicitada',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function renderLocationChart() {
            const chartCanvas = document.getElementById('locationChart');
            if (!chartCanvas) return;
            const ctx = chartCanvas.getContext('2d');
            const locationCounts = {};
            allSolicitudes.forEach(s => {
                const location = s.Ubicacion || 'Sin Ubicación';
                locationCounts[location] = (locationCounts[location] || 0) + 1;
            });
            const labels = Object.keys(locationCounts);
            const data = Object.values(locationCounts);
            if (charts.location) charts.location.destroy();
            charts.location = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Solicitudes',
                        data: data,
                        backgroundColor: [
                            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#6366f1', '#a855f7'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        }
                    }
                }
            });
        }

        function renderReportTable() {
            const tbody = elements.reportTableBody;
            tbody.innerHTML = '';

            let solicitudesToRender = allSolicitudes;
            if (elements.reportFilter.value === 'active') {
                solicitudesToRender = allSolicitudes.filter(sol => sol.Activa === true);
            }

            if (solicitudesToRender.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center p-8 text-gray-500">No hay datos de solicitudes para el reporte.</td></tr>';
                return;
            }
            solicitudesToRender.forEach(solicitud => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                let productosText = 'N/A';
                try {
                    const productos = JSON.parse(solicitud.Productos);
                    productosText = Object.entries(productos)
                        .map(([nombre, cantidad]) => `${nombre}: ${cantidad}`)
                        .join(', ');
                } catch (e) {
                    console.error("Error parsing Productos JSON for report:", e);
                }
                const activeStatus = solicitud.Activa ? 'Sí' : 'No';
                const actionButton = solicitud.Activa ? `
                    <button data-id="${solicitud.ID}" class="finalize-btn bg-green-500 text-white py-1 px-3 rounded-md text-xs font-medium hover:bg-green-600 transition-colors">Finalizar</button>
                ` : `<span class="text-gray-400 text-xs">Finalizada</span>`;
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${solicitud.ID}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${solicitud.Fecha}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${solicitud.Usuario}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${solicitud.Ubicacion}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${solicitud.Tipo}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${solicitud.Comentarios}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${productosText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${activeStatus}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">${actionButton}</td>
                `;
                tbody.appendChild(row);
            });

            document.querySelectorAll('.finalize-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    e.target.disabled = true;
                    e.target.textContent = 'Enviando...';
                    const result = await postToGoogleSheets('finalizeSolicitud', { solicitudId: id });
                    if (result.success) {
                        showNotification('Solicitud finalizada con éxito.', 'success');
                        loadData();
                    } else {
                        showNotification('Error al finalizar la solicitud.', 'error');
                        e.target.disabled = false;
                        e.target.textContent = 'Finalizar';
                    }
                });
            });
        }

        elements.reportFilter.addEventListener('change', renderReportTable);
        elements.loginButton.addEventListener('click', () => elements.loginModal.classList.remove('hidden'));
        elements.closeLoginModalBtn.addEventListener('click', () => elements.loginModal.classList.add('hidden'));
        elements.loginForm.addEventListener('submit', handleLogin);
        elements.signOutButton.addEventListener('click', () => {
            currentUser = { email: null, name: null, nivel: null, isAuthenticated: false };
            elements.userNameDisplay.textContent = '';
            elements.userNameDisplay.classList.add('hidden');
            elements.loginButton.classList.remove('hidden');
            elements.signOutButton.classList.add('hidden');
            document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
            switchView('solicitudesView');
            loadData();
            showNotification('Sesión cerrada.', 'info');
        });

        elements.menuBtn.addEventListener('click', toggleSidebar);
        elements.closeSidebarBtn.addEventListener('click', toggleSidebar);
        elements.backdrop.addEventListener('click', toggleSidebar);

        elements.solicitudesTab.addEventListener('click', (e) => { e.preventDefault(); switchView('solicitudesView'); renderSolicitudes(); });
        if (elements.dashboardTab) { elements.dashboardTab.addEventListener('click', (e) => { e.preventDefault(); switchView('dashboardView'); updateDashboard(); }); }
        if (elements.reportesTab) { elements.reportesTab.addEventListener('click', (e) => { e.preventDefault(); switchView('reportesView'); renderReportTable(); }); }
        if (elements.configTab) { elements.configTab.addEventListener('click', (e) => { e.preventDefault(); switchView('configView'); }); }

        elements.addSolicitudBtn.addEventListener('click', () => {
            if (!currentUser.isAuthenticated) {
                showNotification('Debes iniciar sesión para hacer una solicitud.', 'error');
                return;
            }
            elements.solicitudUser.value = currentUser.name;
            elements.solicitudEmail.value = currentUser.email;
            elements.solicitudDate.valueAsDate = new Date();
            elements.solicitudModal.classList.remove('hidden');
        });
        elements.closeModalBtn.addEventListener('click', () => elements.solicitudModal.classList.add('hidden'));
        elements.cancelFormBtn.addEventListener('click', () => elements.solicitudModal.classList.add('hidden'));

        elements.solicitudForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const selectedProducts = {};
            document.querySelectorAll('#productosContainer input[type="number"]').forEach(input => {
                const productName = input.id.replace('cantidad-', '');
                const quantity = parseInt(input.value);
                if (quantity > 0) {
                    selectedProducts[productName] = quantity;
                }
            });

            if (Object.keys(selectedProducts).length === 0) {
                showNotification('Por favor, ingresa una cantidad para al menos un producto.', 'error');
                return;
            }

            const solicitudData = {
                date: elements.solicitudDate.value,
                type: elements.solicitudType.value,
                location: elements.solicitudLocation.value,
                products: selectedProducts,
                comments: elements.solicitudComments.value,
                user: elements.solicitudUser.value,
                email: elements.solicitudEmail.value,
                userId: currentUser.id
            };
            const result = await postToGoogleSheets('addSolicitud', solicitudData);
            if (result.success) {
                showNotification('Solicitud agregada correctamente.', 'success');
                elements.solicitudModal.classList.add('hidden');
                elements.solicitudForm.reset();
                loadData();
            } else {
                showNotification('Error al enviar la solicitud. Inténtalo de nuevo.', 'error');
            }
        });

        async function postToGoogleSheets(action, data) {
            try {
                const formData = new FormData();
                formData.append('action', action);
                formData.append('data', JSON.stringify(data));
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: formData,
                    redirect: 'follow',
                });
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error en postToGoogleSheets:', error);
                return { success: false, error: 'Error de red. Inténtalo de nuevo.' };
            }
        }

        window.addEventListener('load', loadData);
    </script>
</body>
</html>
